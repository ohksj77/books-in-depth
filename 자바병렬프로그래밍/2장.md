# 2장. 스레드 안정성

- 스레드에 안전한 코드를 작성하는 것은 근본적으로는 상태, 특히 공유되고 변경할 수 있는 상태에 대한 접근을 관리(동기화)하는 것이다.
- synchronized, volatile 변수, 명시적 락, 단일 연산 변수를 사용하는 경우 동기화 라는 용어를 사용한다.

## 2.1 스레드 안정성이란?

- “안전하다”라는 말의 의미
    - 여러 스레드가 클래스에 접근할 때, 어떤 경우에도 정확하게 동작하면 해당 클래스는 스레드 안전하다고 말한다.
    - 스레드 안전한 클래스는 클라이언트 쪽에서 별도로 동기화할 필요 없이 동기화 기능도 캡슐화한다.
- ex) 상태 없는 서블릿

## 2.2 단일 연산

- 병렬 프로그래밍의 입장에서 타이밍이 안 좋을 때 결과가 잘못될 가능성은 굉장히 중요한 개념
    - 경쟁 조건

## 경쟁 조건

- 원하는 결과를 얻을 수 있을지의 여부가 여러 사건의 상대적인 시점에 따라 달라진다.
    - 이런 류의 경쟁 조건을 점검 후 행동이라고 한다.
- 그러한 경우 문제가 발생한다.
- ex) 늦은 초기화 시 경쟁 조건

## 복합 동작

- 단일 연산 작업은 자신을 포함해 같은 상태를 다루는 모든 작업이 단일 연산인 작업을 지칭한다.
- 가능하면 클래스 상태를 관리하기 위해 Atomic 클래스 등 스레드에 안전하게 이미 만들어진 객체를 사용하는 편이 좋다.

## 락

- 상태를 일관성 있게 유지하려면 관련 있는 변수들을 하나의 단일 연산으로 갱신해야 한다.

## 암묵적인 락

- 자바에서 암묵적인 락은 뮤텍스로 동작한다.
    - 락 밖의 스레드가 락을 해제할 방법은 없고 대기해야 한다.

## 재진입성

- 암묵적인 락은 재진입이 가능하다. 재진입성은 스레드 단위로 락을 얻는다는 것을 의미한다.
- 확보 횟수를 통해 재진입 가능 여부를 결정한다.
- 재진입성 때문에 락의 동작을 쉽게 캡슐화할 수 있으며 객체 지향 병렬 프로그램을 개발하기가 단순해졌다.

## 2.4 락으로 상태 보호하기

- 여러 스레드에서 접근할 수 있고 변경 가능한 모든 변수를 대상으로 해당 변수에 접근할 때는 항상 동일한 락을 먼저 확보한 상태여야 한다.
    - 이 경우, 해당 변수는 확보된 락에 의해 보호된다고 말한다.
- 모든 변경할 수 있는 공유 변수는 정확하게 단 하나의 락으로 보호해야 한다.
- 여러 변수에 대한 불변조건이 있으면 해당 변수들은 모두 같은 락으로 보호해야 한다.

## 2.5 활동성과 성능

- 오래 걸리는 작업은 최대한 synchronized 블록(혹은 락 범위)에서 최대한 빼내야 할 필요가 있다.
- 단순성과 성능이 상충할 때가 있는데, 조급하게 단순성을 희생하면 안된다.
- 오래 걸리는 연산이나 네트워크 작업 등에는 가능한 락을 잡지 않는게 좋다.